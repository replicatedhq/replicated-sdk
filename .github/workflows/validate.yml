name: PR/main branch CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  APP_SLUG: replicated-sdk-e2e

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v6
      - uses: dagger/dagger-for-github@v8.2.0
        env:
          OP_SERVICE_ACCOUNT: ${{ secrets.OP_SERVICE_ACCOUNT }}
        with:
          version: "0.19.9"
          verb: call
          args: test --progress=plain --op-service-account=env:OP_SERVICE_ACCOUNT
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

  build:
    runs-on: ubuntu-22.04
    outputs:
      distributions: ${{ steps.distributions.outputs.result }}
    steps:
      - uses: actions/checkout@v6
      - uses: dagger/dagger-for-github@v8.2.0
        id: build
        env:
          OP_SERVICE_ACCOUNT: ${{ secrets.OP_SERVICE_ACCOUNT }}
        with:
          version: "0.19.9"
          verb: call
          args: build-for-e-2-e --progress=plain --op-service-account=env:OP_SERVICE_ACCOUNT export --path=./build-info.json
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

      - name: Extract distributions for matrix
        id: distributions
        run: |
          DISTRIBUTIONS=$(jq -c '.distributions' build-info.json)
          echo "result=$DISTRIBUTIONS" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: build-info.json
          retention-days: 1

  e2e:
    runs-on: ubuntu-22.04
    needs: build
    strategy:
      fail-fast: false
      matrix:
        dist: ${{ fromJson(needs.build.outputs.distributions) }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/download-artifact@v7
        with:
          name: build-info

      - uses: dagger/dagger-for-github@v8.2.0
        env:
          OP_SERVICE_ACCOUNT: ${{ secrets.OP_SERVICE_ACCOUNT }}
        with:
          version: "0.19.9"
          verb: call
          args: run-single-e-2-e --progress=plain --op-service-account=env:OP_SERVICE_ACCOUNT --distribution="${{ matrix.dist.Distribution }}" --version="${{ matrix.dist.Version }}" --build-info-file=./build-info.json
          cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

  validate:
    runs-on: ubuntu-22.04
    needs: [test, e2e]
    if: always()
    steps:
      - name: Check test and e2e results
        run: |
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Unit/Pact tests failed or were cancelled"
            exit 1
          fi
          if [ "${{ needs.e2e.result }}" != "success" ]; then
            echo "E2E tests failed or were cancelled"
            exit 1
          fi
          echo "All tests passed successfully"
